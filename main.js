import{fetchAllParticipantsFromXano as e,startSession as t,submitScore as n}from"./api.js";import{showRecordsOverlay as l}from"./ui.js";import{Icon as o}from"./digit.js";import{cells as a,generatedChunks as s,ensureVisibleChunks as c,drawCells as i,getClickedIcon as r}from"./game.js";function d(e,t=.5){const n=new Audio(e);n.volume=t,n.play().catch(e=>console.error("Sound playback failed:",e))}let m=new Audio("music.mp3");m.loop=!0,m.volume=.3,m.load();const y={particles:[],ripples:[],trails:[],flashAlpha:0,flashColor:[255,204,0]},u=(e,t)=>e+Math.random()*(t-e);function p(e,t,n,l){for(let o=0;o<n;o++){const n=u(0,2*Math.PI),o=u(90,220);y.particles.push({x:e,y:t,vx:Math.cos(n)*o,vy:Math.sin(n)*o,life:u(300,600),age:0,size:u(2,4),color:l,alpha:1})}}function h(e,t,n){y.ripples.push({x:e,y:t,r:0,maxR:120,life:400,age:0,alpha:1,color:n})}function g(e,t,n,l=3){const o=performance.now();for(let a=0;a<l;a++)y.trails.push({x:e,y:t,img:n,start:o+20*a,life:220,alpha:1,scale:1})}function f(e,t="bump",n=220){e&&(e.classList.remove(t),e.offsetWidth,e.classList.add(t),setTimeout(()=>e.classList.remove(t),n+30))}function v(e,t,n){if("key"===e){const e=[255,250,200];p(t,n,18,e),h(t,n,e),y.flashColor=e,y.flashAlpha=Math.min(.1,y.flashAlpha+.18),f(w)}else if("clock"===e){const e=[120,220,255];p(t,n,16,e),h(t,n,e),y.flashColor=e,y.flashAlpha=Math.min(.1,y.flashAlpha+.16),f(b,"pulse",260)}}const E=document.getElementById("hud"),w=document.getElementById("keyCount"),b=document.getElementById("batteryIcon"),k=document.getElementById("batteryPercent"),I=document.getElementById("plusText"),B=document.getElementById("fullscreenButton"),x=document.getElementById("gameMenuButton"),L=document.getElementById("inGameMenuOverlay"),M=document.getElementById("btnFullscreenIG"),C=document.getElementById("btnRestartIG"),A=document.getElementById("btnMainIG");document.getElementById("btnCloseMenu").addEventListener("click",()=>{L.style.display="none"});const S=document.getElementById("btnCloseMenuIcon");S&&S.addEventListener("click",()=>{L.style.display="none"});let R=!0,$=!0;const P=document.getElementById("cbEdgePan"),T=document.getElementById("cbKeyboardPan"),K=document.getElementById("cbRightDragPan"),F=document.getElementById("cbEdgePanMain"),O=document.getElementById("cbKeyboardPanMain"),W=document.getElementById("cbRightDragPanMain");function D(){F&&(F.checked=R),O&&(O.checked=$),W&&(W.checked=!0,W.disabled=!0)}P&&P.addEventListener("change",()=>{R=P.checked}),T&&T.addEventListener("change",()=>{$=T.checked}),K&&(K.checked=!0,K.disabled=!0),F&&F.addEventListener("change",()=>{R=F.checked}),O&&O.addEventListener("change",()=>{$=O.checked}),W&&(W.checked=!0,W.disabled=!0),x.addEventListener("click",()=>{P&&(P.checked=R),T&&(T.checked=$),K&&(K.checked=!0,K.disabled=!0),F&&(F.checked=R),O&&(O.checked=$),W&&(W.checked=!0,W.disabled=!0),L.style.display="flex"});const q=document.getElementById("loginContainer"),G=document.getElementById("walletInput"),j=document.getElementById("loginOkButton"),Y=document.getElementById("loginCloseIcon"),X=document.getElementById("playWithoutWalletButton"),z=document.getElementById("summaryOverlay"),_=document.getElementById("lastRecord"),H=(document.getElementById("refCount"),document.getElementById("timeBonus"),document.getElementById("btnPlayNow")),N=document.getElementById("menuContainer"),U=document.getElementById("btnStart"),V=document.getElementById("btnRecords"),J=(document.getElementById("btnBuy"),document.getElementById("gameCanvas")),Q=J.getContext("2d"),Z=document.getElementById("gameOverOverlay"),ee=document.getElementById("finalScore"),te=document.getElementById("btnMenu"),ne=document.getElementById("btnRestart"),le=document.getElementById("recordsContainer"),oe=document.getElementById("recordsTableContainer"),ae=document.getElementById("closeRecordsButton"),se=document.getElementById("walletSearch");function ce(){const e=se.value.toLowerCase(),t=oe.querySelector("table");if(!t)return;const n=t.querySelectorAll("tr");let l=-1,o=0;const a=oe.querySelector("#noResults");if(a&&a.remove(),n.forEach((t,n)=>{if(0===n)return;const a=t.cells[1];if(a){const s=a.textContent.toLowerCase().includes(e);t.style.display=s||""===e?"":"none",s&&o++,s&&-1===l&&(l=n)}}),""!==e&&0===o){const e=document.createElement("div");e.id="noResults",e.style.color="#FF4444",e.style.marginTop="10px",e.textContent="No wallets found.",oe.appendChild(e)}if(-1!==l&&""!==e){const e=n[l];e.scrollIntoView({behavior:"smooth",block:"center"}),e.style.background="rgba(255, 255, 0, 0.2)",setTimeout(()=>e.style.background="",2e3)}}se.addEventListener("input",ce);let ie="menu",re=null;let de=100,me=0,ye=0,ue=0,pe=[],he=0,ge=0,fe=null,ve=!1,Ee={x:0,y:0},we={x:0,y:0},be=null;J.addEventListener("mousedown",e=>{2===e.button&&(ve=!0,Ee={x:e.clientX,y:e.clientY},we={x:ye,y:ue},d("move.wav",.2))}),J.addEventListener("mousemove",e=>{if(ve){const t=e.clientX-Ee.x,n=e.clientY-Ee.y;ye=we.x+t,ue=we.y+n}}),J.addEventListener("mouseup",e=>{2===e.button&&(ve=!1)}),J.addEventListener("contextmenu",e=>e.preventDefault());const ke=new Set;window.addEventListener("keydown",e=>{switch(e.code){case"KeyW":case"ArrowUp":case"KeyA":case"ArrowLeft":case"KeyS":case"ArrowDown":case"KeyD":case"ArrowRight":ke.add(e.code)}}),window.addEventListener("keyup",e=>{ke.delete(e.code)});let Ie=0,Be=0;function xe(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function Le(){J.width=window.innerWidth,J.height=window.innerHeight}function Me(){w.textContent=me;const e=Math.max(0,Math.min(100,Math.floor(de)));if(k.textContent=`${e}%`,performance.now()<ge)return;let t="per0";e>80?t="per100":e>60?t="per80":e>40?t="per60":e>20?t="per40":e>0&&(t="per20"),b.src=`icons/${t}.svg`}async function Ce(){const e=re?.wallet||null;be=await t(e),be?(m&&(m.pause(),m.currentTime=0),Object.keys(a).forEach(e=>delete a[e]),s.clear(),me=0,de=100,pe=[],ge=0,fe=null,o.shakeFactor=1,ye=ue=0,he=performance.now(),y.particles.length=0,y.ripples.length=0,y.trails.length=0,y.flashAlpha=0,m&&m.play().catch(e=>console.error("Music playback failed:",e)),d("start.wav",.7),Me(),ie="game",Se()):alert("Server isn’t ready. Try again.")}J.addEventListener("mousemove",e=>{const t=J.getBoundingClientRect();Ie=e.clientX-t.left,Be=e.clientY-t.top}),B.addEventListener("click",xe),M.addEventListener("click",()=>{xe()}),C.addEventListener("click",async()=>{L.style.display="none",await Ce()}),A.addEventListener("click",()=>{m&&(m.pause(),m.currentTime=0),L.style.display="none",ie="menu",Se(),D()}),te.addEventListener("click",()=>{m&&(m.pause(),m.currentTime=0),ie="menu",Se(),D()}),ne.addEventListener("click",async()=>{await Ce()}),U.addEventListener("click",()=>{q.style.display="block"}),j.addEventListener("click",async()=>{const t=G.value.trim();if(!/^0x[a-fA-F0-9]{40}$/.test(t))return alert("Invalid wallet!");const n=t.toLowerCase();re={wallet:n,score:0},q.style.display="none";const l=(await e()).find(e=>e.wallet===n)||{score:0};_.textContent=l.score,z.style.display="flex"}),Y&&Y.addEventListener("click",()=>{q.style.display="none"}),X.addEventListener("click",async()=>{re=null,q.style.display="none",await Ce()}),H.addEventListener("click",async()=>{z.style.display="none",await Ce()}),V.addEventListener("click",async()=>{const e=V.textContent;V.textContent="Loading…",V.disabled=!0;try{await l(oe,le,re),se.value="",ce()}finally{V.disabled=!1,V.textContent=e}}),ae.addEventListener("click",()=>{m&&(m.pause(),m.currentTime=0),le.style.display="none",ie="menu",Se(),D()}),window.addEventListener("resize",Le),Le(),J.addEventListener("click",e=>{if("game"!==ie)return;const t=J.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=r(n,l,ye,ue);if(!s)return;const c=a[s];if(c.removeStart)return;const i=performance.now(),m=c.screenPosition(ye,ue,i);if("key"===c.type){c.removeStart=i;const e=o.images[c.type];e&&e.complete&&g(m.x,m.y,e,3),me++,d("plus.wav",.4),v("key",m.x,m.y),Me()}else if("clock"===c.type){c.removeStart=i;const e=o.images[c.type];e&&e.complete&&g(m.x,m.y,e,3),de=Math.min(100,de+10),d("time.wav",.4),v("clock",m.x,m.y),ge=i+1e3,k.textContent=`${Math.floor(de)}%`,b.src="icons/perplus.svg",I.classList.remove("play"),I.offsetWidth,I.classList.add("play")}else de=Math.max(0,de-6),pe.push({key:s,time:i}),d("error.wav",.5),Me()});let Ae=performance.now();function Se(){const e="game"===ie;E.style.display=e?"flex":"none",x.style.display=e?"block":"none",B.style.display="menu"===ie?"block":"none","menu"===ie?(m&&(m.pause(),m.currentTime=0),N.style.display="flex",q.style.display="none",z.style.display="none",J.style.display="none",Z.style.display="none",le.style.display="none"):"game"===ie?(N.style.display="none",q.style.display="none",z.style.display="none",J.style.display="block",Z.style.display="none",le.style.display="none"):"game_over"===ie&&(N.style.display="none",q.style.display="none",z.style.display="none",J.style.display="block",Z.style.display="block",le.style.display="none",ee.innerHTML=`Your score: ${me} <img src="icons/key.svg" alt="Key" style="filter: invert(100%); vertical-align: middle; width: 24px; height: 24px;" />`)}requestAnimationFrame(function e(){const t=performance.now();try{!function(e){if("game"!==ie)return;const t=e/1e3,l=J.width,a=J.height,s=l/2,i=a/2;if(ve);else{if($){const e=480;(ke.has("KeyW")||ke.has("ArrowUp"))&&(ue+=e*t),(ke.has("KeyS")||ke.has("ArrowDown"))&&(ue-=e*t),(ke.has("KeyA")||ke.has("ArrowLeft"))&&(ye+=e*t),(ke.has("KeyD")||ke.has("ArrowRight"))&&(ye-=e*t)}if(R){const e=.35*l,n=.35*a;if(Ie<s-e||Ie>s+e||Be<i-n||Be>i+n){let l=(Ie-s)/s,o=(Be-i)/i;const a=Math.hypot(l,o);a>1&&(l/=a,o/=a);let c=0,r=0;Ie<s-e?c=(s-e-Ie)/(s-e):Ie>s+e&&(c=(Ie-(s+e))/(s-e)),Be<i-n?r=(i-n-Be)/(i-n):Be>i+n&&(r=(Be-(s+n))/(s-e));const d=400*(1+Math.min(1,Math.max(c,r)));ye-=l*d*t,ue-=o*d*t}}}const r=performance.now(),u=(r-he)/1e3;o.shakeFactor=1+2*Math.min(u/50,1),de-=2*t;const p=Math.max(0,Math.min(100,Math.floor(de)));if(p!==fe&&r>=ge&&(fe=p,Me()),de<=0)return ie="game_over",be&&(n(be,me,re?.wallet||null).catch(console.error),be=null),m&&(m.pause(),m.currentTime=0),d("end.wav",.5),void Se();c(ye,ue,l,a);for(let n=y.particles.length-1;n>=0;n--){const l=y.particles[n];if(l.age+=e,l.age>=l.life){y.particles.splice(n,1);continue}const o=l.age/l.life;l.vy+=200*t,l.x+=l.vx*t,l.y+=l.vy*t,l.alpha=1-o}for(let t=y.ripples.length-1;t>=0;t--){const n=y.ripples[t];if(n.age+=e,n.age>=n.life){y.ripples.splice(t,1);continue}const l=n.age/n.life;n.r=n.maxR*l,n.alpha=1-l}const h=performance.now();for(let e=y.trails.length-1;e>=0;e--){const t=y.trails[e],n=h-t.start;n<0||(n>=t.life?y.trails.splice(e,1):(t.alpha=1-n/t.life,t.scale=1+n/t.life*.25))}y.flashAlpha=Math.max(0,y.flashAlpha-1.6*t)}(t-Ae),function(){if("game"!==ie)return;const e=performance.now();Q.clearRect(0,0,J.width,J.height),i(Q,ye,ue,J.width,J.height,e),Q.save();for(const e of y.trails){if(!e.img||e.alpha<=0)continue;Q.globalAlpha=.6*e.alpha;const t=30*(e.scale||1);Q.drawImage(e.img,e.x-t/2,e.y-t/2,t,t)}Q.restore();for(const e of y.ripples)Q.save(),Q.globalAlpha=.45*(e.alpha||1),Q.strokeStyle=`rgba(${e.color[0]}, ${e.color[1]}, ${e.color[2]}, ${e.alpha||1})`,Q.lineWidth=2,Q.beginPath(),Q.arc(e.x,e.y,e.r,0,2*Math.PI),Q.stroke(),Q.restore();Q.save(),Q.globalCompositeOperation="lighter";for(const e of y.particles)Q.globalAlpha=e.alpha||1,Q.fillStyle=`rgb(${e.color[0]}, ${e.color[1]}, ${e.color[2]})`,Q.beginPath(),Q.arc(e.x,e.y,e.size,0,2*Math.PI),Q.fill();Q.restore();for(let t=pe.length-1;t>=0;t--){const n=pe[t],l=a[n.key];if(!l||e-n.time>1e3){pe.splice(t,1);continue}const o=l.screenPosition(ye,ue,e),s=30;Q.save(),Q.globalAlpha=.5*(1-(e-n.time)/1e3),Q.fillStyle="red",Q.fillRect(o.x-s/2,o.y-s/2,s,s),Q.restore()}const t=J.width,n=J.height;Q.save();const l=Q.createRadialGradient(Ie,Be,0,Ie,Be,500);if(l.addColorStop(0,"rgba(0,0,0,0)"),l.addColorStop(1,"rgba(0,0,0,1)"),Q.fillStyle=l,Q.fillRect(0,0,t,n),Q.restore(),de<=20){const e=1-de/20;Q.save(),Q.fillStyle=`rgba(0,0,0,${e})`,Q.fillRect(0,0,t,n),Q.restore()}if(y.flashAlpha>0){Q.save();const[e,t,n]=[255,255,220],l=Math.min(1,.2*Math.pow(y.flashAlpha,.6)),o=.5*Math.max(J.width,J.height),a=Q.createRadialGradient(Ie,Be,0,Ie,Be,o);a.addColorStop(0,`rgba(${e}, ${t}, ${n}, ${l})`),a.addColorStop(1,`rgba(${e}, ${t}, ${n}, 0)`),Q.globalCompositeOperation="lighter",Q.fillStyle=a,Q.fillRect(0,0,J.width,J.height),Q.restore()}}()}catch(e){console.error("Error in loop:",e)}Ae=t,requestAnimationFrame(e)}),Se(),o._loadImages();